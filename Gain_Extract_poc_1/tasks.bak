import os
import datetime
from pathlib import Path

from robocorp import browser
from robocorp.tasks import task

OUTPUT_DIR = Path(os.getenv("ROBOT_ARTIFACTS", "output"))

# Credentials
LOGIN_URL = "https://ikm.uat.gaindms.com/"
DEALER_CODE = "cr001"
BRANCH_SLNO = "201"
USERNAME = "kadmin"
PASSWORD = "k"

EXPORT_BASE_URL = "https://ikm.uat.gaindms.com/Common/ExportToExcel.aspx"

@task
def fetch_gain_dms_report():
    browser.configure(browser_engine="chromium", headless=True, screenshot="only-on-failure")
    page = browser.goto(LOGIN_URL)

    # Login
    page.fill("input[name='txtDealerCode']", DEALER_CODE)
    page.select_option("select[name='ddlBranch']", BRANCH_SLNO)
    page.fill("input[name='txtUserName']", USERNAME)
    page.fill("input[name='txtPassword']", PASSWORD)
    page.click("input[name='btnLogin']")

    # Calculate T-1 date
    yesterday = datetime.date.today() - datetime.timedelta(days=1)
    formatted_date = yesterday.strftime("%m-%d-%Y")  # Format: MM-DD-YYYY

    # Construct export URL with dynamic date
    export_url = (
        f"{EXPORT_BASE_URL}?PS=@p_TopN,!all!;"
        f"%20@p_ReceiptMode,!A!;"
        f"%20@p_FromDate,!{formatted_date}!;"
        f"%20@p_ToDate,!{formatted_date}!;"
        f"%20@p_CancelReceipt,!0!;"
        f"%20@p_PaymentModeSlno,0;"
        f"%20@p_ReceiptAmount,0;"
        f"%20@p_ReceiptNo,!!;"
        f"%20@p_NameInReceipt,!!;"
        f"%20@p_ChequeNo,!!;"
        f"%20@p_BranchSlno,0;"
        f"%20@p_FinancierPayment,!0!;"
        f"@DealerGroupSlno,1;"
        f"@p_ForBranchSlno,0;"
        f"@p_ForFranchiseSlno,9;"
        f"@p_MultiDealer,!28!;"
        f"@p_CompanySlno,0"
        f"&PN=EXEC%20Accounts.dbo.[ReceiptWorkSheet_proc_Exprot]%20"
        f"&RptSlno=680"
        f"&rptName=ReceiptList.rpt"
    )

    # Trigger download
    with page.expect_download() as download_info:
        page.goto(export_url)
    download = download_info.value

    # Save the file to output folder
    file_name = f"gainDMS_receipt_{yesterday.strftime('%Y%m%d')}.xlsx"
    download_path = OUTPUT_DIR / file_name
    download.save_as(download_path)
    print(f"Downloaded file saved to: {download_path}")
